{"ast":null,"code":"/* global __webpack_dev_server_client__ */\n\nimport WebSocketClient from \"./clients/WebSocketClient.js\";\nimport { log } from \"./utils/log.js\";\n\n/** @typedef {import(\"./index.js\").EXPECTED_ANY} EXPECTED_ANY */\n/** @typedef {import(\"./clients/SockJSClient\")} SockJSClient */\n\n// this WebsocketClient is here as a default fallback, in case the client is not injected\n/** @type {CommunicationClientConstructor} */\nvar Client = typeof __webpack_dev_server_client__ !== \"undefined\" ? typeof (/** @type {{ default: CommunicationClientConstructor }} */\n__webpack_dev_server_client__.default) !== \"undefined\" ? /** @type {{ default: CommunicationClientConstructor }} */\n__webpack_dev_server_client__.default : (/** @type {CommunicationClientConstructor} */\n__webpack_dev_server_client__) : WebSocketClient;\nvar retries = 0;\nvar maxRetries = 10;\n\n// Initialized client is exported so external consumers can utilize the same instance\n// It is mutable to enforce singleton\n/** @type {CommunicationClient | null} */\n// eslint-disable-next-line import/no-mutable-exports\nexport var client = null;\n\n/** @type {ReturnType<typeof setTimeout> | undefined} */\nvar timeout;\n\n/**\n * @param {string} url url\n * @param {{ [handler: string]: (data?: EXPECTED_ANY, params?: EXPECTED_ANY) => EXPECTED_ANY }} handlers handlers\n * @param {number=} reconnect count of reconnections\n */\nfunction socket(url, handlers, reconnect) {\n  client = new Client(url);\n  client.onOpen(function () {\n    retries = 0;\n    if (timeout) {\n      clearTimeout(timeout);\n    }\n    if (typeof reconnect !== \"undefined\") {\n      maxRetries = reconnect;\n    }\n  });\n  client.onClose(function () {\n    if (retries === 0) {\n      handlers.close();\n    }\n\n    // Try to reconnect.\n    client = null;\n\n    // After 10 retries stop trying, to prevent logspam.\n    if (retries < maxRetries) {\n      // Exponentially increase timeout to reconnect.\n      // Respectfully copied from the package `got`.\n      var retryInMs = 1000 * Math.pow(2, retries) + Math.random() * 100;\n      retries += 1;\n      log.info(\"Trying to reconnect...\");\n      timeout = setTimeout(function () {\n        socket(url, handlers, reconnect);\n      }, retryInMs);\n    }\n  });\n  client.onMessage(\n  /**\n   * @param {EXPECTED_ANY} data data\n   */\n  function (data) {\n    var message = JSON.parse(data);\n    if (handlers[message.type]) {\n      handlers[message.type](message.data, message.params);\n    }\n  });\n}\nexport default socket;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}